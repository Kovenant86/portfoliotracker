<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Portfolio Dashboard</title>
<style>
 body { background-color: #1e1e1e; color: #ccc; font-family: Arial, sans-serif; }
 table { border-collapse: collapse; width: 100%; margin-top: 1em; }
 th, td { border: 1px solid #444; padding: 4px 8px; text-align: right; }
 th { background-color: #333; }
 td.name { text-align: left; }
 .green { color: #0f0; }
 .red { color: #f00; }
 .toolbar { margin: 1em 0; }
 .toolbar button { margin-right: 5px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<h1>Portfolio Dashboard</h1>
<div class="toolbar">
  <button id="btnExport">Export JSON</button>
  <input id="fileImport" type="file" accept="application/json" style="display:none">
  <button id="btnImport">Import JSON</button>
  <button id="btnClear">Clear All</button>
  <input id="fileXLSX" type="file" accept=".xlsx,.xls,.csv" style="display:none">
  <button id="btnImportX">Import Excel/CSV</button>
</div>
<div id="dashboard"></div>
<script>
const LS_KEY = 'portfolioState';
let state = { investments: [], months: [], fx: {}, income: {}, totalInvestments: {} };

function save() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function load() { const s = localStorage.getItem(LS_KEY); if(s) state = JSON.parse(s); }
function formatMoney(num) { return num.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }
function renderAll() {
  const div = document.getElementById('dashboard');
  let html = '<table><tr><th>Investment</th>';
  state.months.forEach(m=> html += `<th>${m}</th>`);
  html += '</tr>';
  state.investments.forEach(inv => {
    html += `<tr><td class="name">${inv.name}</td>`;
    state.months.forEach(m=> {
      let val = inv.values[m] || 0;
      html += `<td>${formatMoney(val)}</td>`;
    });
    html += '</tr>';
  });
  html += '</table>';
  div.innerHTML = html;
}

// Export JSON
btnExport.onclick = () => {
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'portfolio.json';
  a.click();
  URL.revokeObjectURL(a.href);
};
// Import JSON
btnImport.onclick = () => fileImport.click();
fileImport.onchange = e => {
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = () => { try{ state = JSON.parse(r.result); save(); renderAll(); } catch(e){ alert('Invalid JSON'); } };
  r.readAsText(f);
};
// Clear All
btnClear.onclick = () => { if(confirm('Clear all?')) { localStorage.removeItem(LS_KEY); location.reload(); } };

// Import Excel/CSV
btnImportX.onclick = () => fileXLSX.click();
fileXLSX.onchange = async e => {
  const f = e.target.files[0]; if(!f) return;
  const data = await f.arrayBuffer();
  let wb; try{ wb = XLSX.read(data, {type:'array'}); } catch(err){ alert('Failed to read file'); return; }
  const wsname = wb.SheetNames[0];
  const ws = wb.Sheets[wsname];
  const arr = XLSX.utils.sheet_to_json(ws, {header:1, raw:false, defval:''});
  try{ importFrom2D(arr); alert('Import complete!'); } catch(err){ alert('Import error: '+err.message); }
  save(); renderAll();
};

function importFrom2D(rows){
  const MONTH_NAMES = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
  const isMonthWord = s => MONTH_NAMES.includes(String(s).slice(0,3).toLowerCase());
  let headerRowIdx = -1;
  for(let r=0;r<rows.length;r++){
    const count = rows[r].filter(c => isMonthWord(c) || /^\d{4}-\d{2}$/.test(String(c).trim())).length;
    if(count>=3) { headerRowIdx=r; break; }
  }
  if(headerRowIdx<0) throw new Error('Header row not found');
  const headerRow = rows[headerRowIdx];
  let months=[]; let curYear = null; let lastMonthNum=null;
  for(let c=1;c<headerRow.length;c++){
    const cell = String(headerRow[c]||'').trim();
    if(/^\d{4}-\d{2}$/.test(cell)) { months.push({col:c, key:cell}); curYear = +cell.slice(0,4); lastMonthNum = +cell.slice(5,7); continue; }
    if(isMonthWord(cell)) {
      if(curYear==null) curYear = +prompt(`Enter year for ${cell}`, new Date().getFullYear());
      const idx = MONTH_NAMES.indexOf(cell.slice(0,3).toLowerCase());
      let mnum = idx+1; if(lastMonthNum && mnum<lastMonthNum) curYear++;
      lastMonthNum = mnum; months.push({col:c, key:`${curYear}-${String(mnum).padStart(2,'0')}`});
    }
  }
  state.months = months.map(m=>m.key);
  const investments=[];
  for(let r=headerRowIdx+1;r<rows.length;r++){
    const name = String(rows[r][0]||'').trim();
    if(!name || /^total/i.test(name)) break;
    const inv = { name, currency: 'USD', values:{} };
    months.forEach(({col,key})=>{
      const num = parseMoney(rows[r][col]);
      if(num!=null) inv.values[key] = num;
    });
    investments.push(inv);
  }
  state.investments = investments;
  state.fx = {}; state.income = {}; state.totalInvestments = {};
  state.months.forEach(m=>{ state.fx[m] = {USD:1, EUR:0, RON:0}; state.income[m]=0; state.totalInvestments[m]=0; });
}
function parseMoney(s){
  if(s===undefined||s===null) return null;
  s = String(s).replace(/RON|EUR|USD|lei|\$/gi,'').replace(/\u20ac/g,'').replace(/[\,\s]/g,'');
  if(s==='') return null;
  const v = Number(s);
  return isFinite(v)?v:null;
}

load();
renderAll();
</script>
</body>
</html>
