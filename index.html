<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Investment Tracker</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121822;
      --muted: #a9b1bd;
      --text: #e6edf3;
      --accent: #6ad0ff;
      --accent-2: #9c6bff;
      --danger: #ff6b6b;
      --ok: #5dd39e;
      --grid: #1c2430;
      --card: #0f141c;
      --border: #223041;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
      color: var(--text);
      background: radial-gradient(1200px 800px at 80% -10%, #10203355, transparent 60%),
                  radial-gradient(900px 700px at -10% 20%, #1a2b3f44, transparent 60%),
                  var(--bg);
      line-height: 1.3;
    }
    header {
      position: sticky; top: 0; z-index: 20;
      background: linear-gradient(180deg, #0b0f14ee, #0b0f14cc 60%, transparent);
      backdrop-filter: saturate(120%) blur(6px);
      border-bottom: 1px solid var(--border);
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 {
      margin: 0;
      font-size: clamp(20px, 3vw, 28px);
      letter-spacing: 0.3px;
      display: flex; align-items: center; gap: 10px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 18px;
    }
    @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }
    section.card {
      background: linear-gradient(180deg, #111827cc, #0e1622ee);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    label { font-size: 12px; color: var(--muted); }
    select, input[type="number"], input[type="text"] {
      background: #0d1520; color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px; padding: 8px 10px; font-size: 14px;
      outline: none;
    }
    select:focus, input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px #6ad0ff22; }
    button {
      background: linear-gradient(90deg, #1b3a52, #2b295a);
      color: var(--text); border: 1px solid var(--border);
      padding: 9px 12px; border-radius: 10px; font-weight: 700;
      cursor: pointer;
    }
    button:hover { filter: brightness(1.1); }
    .muted { color: var(--muted); }
    canvas { width: 100%; height: 320px; background: var(--card); border-radius: 10px; }
    .table { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    th, td { padding: 8px 10px; border-bottom: 1px solid var(--border); text-align: right; }
    th { text-align: left; color: var(--muted); font-weight: 600; background: #0f1723; position: sticky; top: 0; }
    tr:last-child td { border-bottom: none; }
    .kpi-grid {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
    }
    @media (max-width: 720px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
    .kpi {
      background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px;
    }
    .kpi h3 { margin: 0 0 6px 0; font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .8px; }
    .kpi .val { font-size: 22px; font-weight: 800; }
    .kpi .sub { font-size: 12px; color: var(--muted); }
    .pos { color: var(--ok); } .neg { color: var(--danger); }
    .footer { color: var(--muted); font-size: 12px; margin-top: 6px; }
    .note { font-size: 12px; color: var(--muted); }
    .divider { height: 1px; background: var(--border); margin: 10px 0; }
    .controls { display: grid; grid-template-columns: repeat(4, minmax(140px, 1fr)); gap: 10px; }
    @media (max-width: 1000px) { .controls { grid-template-columns: repeat(2, 1fr); } }
    .right { text-align: right; margin-left: auto; }
    .badge { padding: 2px 6px; font-size: 11px; border-radius: 6px; border: 1px solid var(--border); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .account-card {
      border: 1px dashed var(--border);
      background: #0c141f;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 12px;
    }
    .account-header { display: flex; align-items: center; gap: 10px; }
    .account-header input[type="text"] { width: 220px; }
    .account-actions { margin-left: auto; display: flex; gap: 8px; }
    .small { font-size: 12px; padding: 6px 8px; }
    .pill { font-size: 11px; padding: 3px 6px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Investment Tracker</h1>
      <div class="row" style="margin-top:8px;">
        <span class="muted">Dashboard multi-cont pentru urmƒÉrirea investi»õiilor: grafice, conversii valutare, % MoM »ôi % YTD. Datele se salveazƒÉ local.</span>
      </div>
    </div>
  </header>

  <main class="wrap" style="margin-top:10px;">
    <section class="card">
      <div class="row" style="justify-content: space-between; gap: 12px;">
        <div class="controls" style="flex:1">
          <div>
            <label for="yearSel">An</label><br>
            <select id="yearSel"></select>
          </div>
          <div>
            <label for="displayCurrency">Moneda de afi»ôare</label><br>
            <select id="displayCurrency">
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="RON">RON</option>
            </select>
          </div>
          <div>
            <label>Rate FX cƒÉtre USD</label>
            <div class="row">
              <span class="badge">1 EUR =</span>
              <input type="number" id="eurusd" step="0.0001" value="1.10" style="width:110px;" />
              <span class="badge">1 RON =</span>
              <input type="number" id="ronusd" step="0.0001" value="0.2250" style="width:110px;" />
            </div>
            <div class="note">Po»õi ajusta ratele manual (valori exemplu).</div>
          </div>
          <div>
            <label>Ac»õiuni</label><br>
            <div class="row">
              <button id="addAccountBtn" class="small">‚ûï AdaugƒÉ cont</button>
              <button id="sampleBtn" class="small" title="√éncarcƒÉ conturi »ôi valori exemplu">üí° Exemplu</button>
              <button id="saveBtn" class="small" title="SalveazƒÉ √Æn browser">üíæ SalveazƒÉ</button>
              <button id="resetBtn" class="small" title="ReseteazƒÉ tot">‚ôªÔ∏è Reset</button>
            </div>
          </div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="kpi-grid">
        <div class="kpi">
          <h3>Total √Æn USD (sumƒÉ 12 luni)</h3>
          <div class="val" id="kpiTotalUSD">‚Äî</div>
          <div class="sub">Conversie dupƒÉ ratele setate</div>
        </div>
        <div class="kpi">
          <h3>Valoare curentƒÉ (luna cea mai recentƒÉ)</h3>
          <div class="val" id="kpiCurrent">‚Äî</div>
          <div class="sub">√Æn moneda de afi»ôare</div>
        </div>
        <div class="kpi">
          <h3>Œî % lunƒÉ / lunƒÉ (MoM)</h3>
          <div class="val" id="kpiMoM">‚Äî</div>
          <div class="sub">fa»õƒÉ de luna anterioarƒÉ</div>
        </div>
        <div class="kpi">
          <h3>Œî % YTD</h3>
          <div class="val" id="kpiYTD">‚Äî</div>
          <div class="sub">de la √Ænceputul anului</div>
        </div>
      </div>
    </section>

    <div class="grid" style="margin-top:14px;">
      <section class="card">
        <h2 style="margin:4px 0 10px 0; font-size:16px;">Evolu»õie portofoliu ‚Äî grafic (total conturi)</h2>
        <canvas id="chart" width="900" height="340"></canvas>
        <div class="footer">Grafic desenat nativ pe canvas (fƒÉrƒÉ librƒÉrii externe).</div>
      </section>

      <section class="card">
        <h2 style="margin:4px 0 10px 0; font-size:16px;">Conturi</h2>
        <div class="note" style="margin-bottom:8px;">Po»õi avea oric√¢te conturi. Fiecare cont are <span class="pill">nume</span>, <span class="pill">monedƒÉ</span> »ôi <span class="pill">valori lunare</span>.</div>
        <div id="accounts"></div>
      </section>
    </div>

    <section class="card" style="margin-top:14px;">
      <h2 style="margin:4px 0 10px 0; font-size:16px;">Detalii calcul (sumƒÉ totalƒÉ a tuturor conturilor)</h2>
      <div class="table">
        <table>
          <thead>
            <tr>
              <th>LunƒÉ</th>
              <th class="right">Total USD</th>
              <th class="right">Afi»ôare</th>
              <th class="right">% MoM</th>
              <th class="right">% YTD</th>
            </tr>
          </thead>
          <tbody id="calcRows"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // --- Helpers
    const months = ["Ian","Feb","Mar","Apr","Mai","Iun","Iul","Aug","Sep","Oct","Noi","Dec"];
    const $ = (id) => document.getElementById(id);
    const fmt = (v, cur) => {
      if (v === null || Number.isNaN(v)) return "‚Äî";
      const n = new Intl.NumberFormat('ro-RO',{ maximumFractionDigits: 2 }).format(v);
      return n + (cur ? " " + cur : "");
    };
    const pct = (v) => (v === null || Number.isNaN(v)) ? "‚Äî" : (v >= 0 ? "+" : "") + v.toFixed(2) + "%";
    const uid = () => Math.random().toString(36).slice(2,9);

    // --- State
    const state = {
      years: [],
      accounts: {},   // {[year]: [{id, name, currency, values:number[12]}]}
      fx: { EURUSD: 1.10, RONUSD: 0.2250 },
      display: 'USD'
    };

    // --- Initialize years (current +/- 2)
    const now = new Date();
    const curYear = now.getFullYear();
    state.years = [curYear-2, curYear-1, curYear, curYear+1];
    const yearSel = $('yearSel');
    state.years.forEach(y => {
      const opt = document.createElement('option');
      opt.value = y; opt.textContent = y;
      if (y === curYear) opt.selected = true;
      yearSel.appendChild(opt);
    });

    function ensureYear(y) {
      if (!state.accounts[y]) state.accounts[y] = [];
    }

    // --- localStorage
    function loadLS() {
      try {
        const raw = localStorage.getItem('invTrackerV2');
        if (!raw) return;
        const obj = JSON.parse(raw);
        Object.assign(state, obj);
        $('displayCurrency').value = state.display || 'USD';
        $('eurusd').value = state.fx.EURUSD ?? 1.10;
        $('ronusd').value = state.fx.RONUSD ?? 0.2250;
      } catch(e) { console.error(e); }
    }
    function saveLS() {
      localStorage.setItem('invTrackerV2', JSON.stringify(state));
    }

    // --- Currency conversions
    function toUSD(amount, from) {
      if (amount === null || Number.isNaN(amount)) return null;
      if (from === 'USD') return amount;
      if (from === 'EUR') return amount * state.fx.EURUSD;
      if (from === 'RON') return amount * state.fx.RONUSD;
      return amount;
    }
    function fromUSD(amount, to) {
      if (amount === null || Number.isNaN(amount)) return null;
      if (to === 'USD') return amount;
      if (to === 'EUR') return amount / state.fx.EURUSD;
      if (to === 'RON') return amount / state.fx.RONUSD;
      return amount;
    }

    // --- Accounts UI
    const accountsEl = $('accounts');

    function accountCard(acc, index) {
      const wrap = document.createElement('div');
      wrap.className = 'account-card';
      wrap.dataset.id = acc.id;

      const header = document.createElement('div');
      header.className = 'account-header';

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = 'Nume cont';
      nameInput.value = acc.name || `Cont ${index+1}`;
      nameInput.addEventListener('input', () => { acc.name = nameInput.value; saveLS(); });

      const currSel = document.createElement('select');
      ['USD','EUR','RON'].forEach(c => {
        const opt = document.createElement('option'); opt.value = c; opt.textContent = c;
        if (acc.currency === c) opt.selected = true;
        currSel.appendChild(opt);
      });
      currSel.addEventListener('change', () => { acc.currency = currSel.value; render(); });

      const actions = document.createElement('div');
      actions.className = 'account-actions';
      const delBtn = document.createElement('button');
      delBtn.textContent = 'üóëÔ∏è »òterge';
      delBtn.className = 'small';
      delBtn.addEventListener('click', () => {
        const y = +yearSel.value;
        state.accounts[y] = state.accounts[y].filter(a => a.id !== acc.id);
        render();
      });
      actions.appendChild(delBtn);

      header.appendChild(nameInput);
      header.appendChild(currSel);
      header.appendChild(actions);
      wrap.appendChild(header);

      // monthly table
      const tableWrap = document.createElement('div');
      tableWrap.className = 'table';
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr><th>LunƒÉ</th><th style="text-align:right;">Valoare ('+acc.currency+')</th></tr>';
      const tbody = document.createElement('tbody');

      months.forEach((m,i)=>{
        const tr = document.createElement('tr');
        const th = document.createElement('th'); th.textContent = m;
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'number'; input.step = '0.01'; input.placeholder = '0.00';
        input.style.width = '140px'; input.value = (acc.values[i] ?? '');
        input.addEventListener('input', () => {
          const v = parseFloat(input.value);
          acc.values[i] = Number.isFinite(v) ? v : null;
          render(); // re-render totals & chart
        });
        td.appendChild(input);
        tr.appendChild(th); tr.appendChild(td);
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      tableWrap.appendChild(table);
      wrap.appendChild(tableWrap);

      return wrap;
    }

    function renderAccounts() {
      accountsEl.innerHTML = '';
      const y = +yearSel.value;
      ensureYear(y);
      const arr = state.accounts[y];
      if (!arr.length) {
        const empty = document.createElement('div');
        empty.className = 'note';
        empty.textContent = 'Nu existƒÉ conturi √ÆncƒÉ. ApasƒÉ ‚ÄûAdaugƒÉ cont‚Äù pentru a √Æncepe.';
        accountsEl.appendChild(empty);
        return;
      }
      arr.forEach((acc, idx) => accountsEl.appendChild(accountCard(acc, idx)));
    }

    function addAccount(preset) {
      const y = +yearSel.value;
      ensureYear(y);
      const acc = {
        id: uid(),
        name: preset?.name || `Cont ${state.accounts[y].length+1}`,
        currency: preset?.currency || 'USD',
        values: preset?.values || Array(12).fill(null)
      };
      state.accounts[y].push(acc);
      render();
    }

    // --- Calculations (combine all accounts per month)
    function calcTotalsForYear(y) {
      ensureYear(y);
      const disp = $('displayCurrency').value;
      const monthsCount = 12;
      const usdTotals = Array(monthsCount).fill(0);
      let hasAny = false;

      state.accounts[y].forEach(acc => {
        for (let i=0;i<monthsCount;i++) {
          const v = acc.values[i];
          if (v !== null && Number.isFinite(v)) {
            hasAny = true;
            const inUSD = toUSD(v, acc.currency);
            usdTotals[i] += inUSD || 0;
          }
        }
      });

      const dispTotals = usdTotals.map(v => fromUSD(v, disp));
      // If there was no data at all, mark as nulls
      const allZero = !hasAny;
      const dispVals = allZero ? Array(12).fill(null) : dispTotals;

      const mom = dispVals.map((v,i)=>{
        if (i===0 || v===null) return null;
        const prev = dispVals[i-1];
        if (prev===null || prev===0) return null;
        return ((v - prev)/Math.abs(prev))*100;
      });

      const firstIdx = dispVals.findIndex(v => v!==null);
      const ytd = dispVals.map((v,i)=>{
        if (firstIdx === -1 || i < firstIdx || v===null || dispVals[firstIdx]===0) return null;
        return ((v - dispVals[firstIdx])/Math.abs(dispVals[firstIdx]))*100;
      });

      const sumUSD = usdTotals.reduce((s,v)=> s + (Number.isFinite(v)? v : 0), 0);
      const lastIdx = [...dispVals].reverse().findIndex(v => v !== null);
      const lastAbsIdx = lastIdx === -1 ? -1 : (dispVals.length - 1 - lastIdx);
      const currentVal = lastAbsIdx >= 0 ? dispVals[lastAbsIdx] : null;
      const currentMoM = lastAbsIdx > 0 ? mom[lastAbsIdx] : null;
      const currentYTD = lastAbsIdx >= 0 ? ytd[lastAbsIdx] : null;

      return { usdTotals, dispVals, mom, ytd, sumUSD, currentVal, currentMoM, currentYTD };
    }

    // --- Chart (canvas 2D, simple line)
    const chart = $('chart');
    const ctx = chart.getContext('2d');
    function drawChart(values) {
      const W = chart.width, H = chart.height;
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--card');
      ctx.fillRect(0,0,W,H);

      // grid
      const gridY = 5;
      ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--grid');
      ctx.lineWidth = 1;
      ctx.beginPath();
      for (let i=0;i<=gridY;i++) {
        const y = 20 + (H-40) * i / gridY;
        ctx.moveTo(50, y); ctx.lineTo(W-10, y);
      }
      ctx.stroke();

      // axes
      ctx.strokeStyle = '#2a3b52';
      ctx.beginPath();
      ctx.moveTo(50, 10); ctx.lineTo(50, H-20);
      ctx.moveTo(50, H-20); ctx.lineTo(W-10, H-20);
      ctx.stroke();

      const valid = values.filter(v => v!==null);
      if (!valid.length) return;

      const min = Math.min(...valid);
      const max = Math.max(...valid);
      const padT = 18, padB = 28, padL = 55, padR = 15;
      const X = (i) => padL + ( (W - padL - padR) * i / (values.length-1) );
      const Y = (v) => padT + ( (H - padT - padB) * (1 - (v - min) / (max - min || 1)) );

      // line
      ctx.lineWidth = 2.4;
      const grad = ctx.createLinearGradient(0,0,W,0);
      grad.addColorStop(0, getComputedStyle(document.body).getPropertyValue('--accent'));
      grad.addColorStop(1, getComputedStyle(document.body).getPropertyValue('--accent-2'));
      ctx.strokeStyle = grad;
      ctx.beginPath();
      values.forEach((v,i) => {
        if (v===null) return;
        const x = X(i), y = Y(v);
        if (i===0 || values[i-1]===null) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      // fill
      const fillGrad = ctx.createLinearGradient(0,0,0,H);
      fillGrad.addColorStop(0, '#6ad0ff22');
      fillGrad.addColorStop(1, '#9c6bff06');
      ctx.fillStyle = fillGrad;
      ctx.beginPath();
      let started = false;
      values.forEach((v,i) => {
        if (v===null) return;
        const x = X(i), y = Y(v);
        if (!started) { ctx.moveTo(x,y); started = true; }
        else ctx.lineTo(x,y);
      });
      if (started) {
        const lastIdx = values.reduce((a,v,i)=> v!==null? i : a, 0);
        ctx.lineTo(X(lastIdx), H-20);
        ctx.lineTo(X(values.findIndex(v=>v!==null)), H-20);
        ctx.closePath();
        ctx.fill();
      }

      // labels
      ctx.fillStyle = '#9fb0c6';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto';
      months.forEach((m,i)=>{
        const x = X(i);
        ctx.fillText(m, x-10, H-6);
      });

      // min/max markers
      ctx.fillStyle = '#c9d7e8';
      ctx.textAlign = 'right';
      ctx.fillText(fmt(min), padL-6, Y(min)+4);
      ctx.fillText(fmt(max), padL-6, Y(max)+4);
      ctx.textAlign = 'left';
    }

    // --- Render
    function render() {
      const y = +$('yearSel').value;
      ensureYear(y);
      // sync globals
      state.fx.EURUSD = parseFloat($('eurusd').value) || 1.10;
      state.fx.RONUSD = parseFloat($('ronusd').value) || 0.2250;
      state.display = $('displayCurrency').value;

      renderAccounts();

      const s = calcTotalsForYear(y);
      $('kpiTotalUSD').textContent = fmt(s.sumUSD, 'USD');
      $('kpiCurrent').textContent = fmt(s.currentVal, state.display);
      $('kpiMoM').innerHTML = (s.currentMoM===null? '‚Äî' : `<span class="${s.currentMoM>=0?'pos':'neg'}">${pct(s.currentMoM)}</span>`);
      $('kpiYTD').innerHTML = (s.currentYTD===null? '‚Äî' : `<span class="${s.currentYTD>=0?'pos':'neg'}">${pct(s.currentYTD)}</span>`);

      // detail table
      const calc = $('calcRows');
      calc.innerHTML = '';
      s.dispVals.forEach((v,i)=>{
        const tr = document.createElement('tr');
        const tds = [
          months[i],
          fmt(s.usdTotals[i], 'USD'),
          fmt(v, state.display),
          s.mom[i]===null ? '‚Äî' : (s.mom[i]>=0? `<span class="pos">${pct(s.mom[i])}</span>` : `<span class="neg">${pct(s.mom[i])}</span>`),
          s.ytd[i]===null ? '‚Äî' : (s.ytd[i]>=0? `<span class="pos">${pct(s.ytd[i])}</span>` : `<span class="neg">${pct(s.ytd[i])}</span>`)
        ];
        tds.forEach((txt, j)=>{
          const td = document.createElement('td');
          td.innerHTML = (j===0) ? `<span class="mono">${txt}</span>` : txt;
          tr.appendChild(td);
        });
        calc.appendChild(tr);
      });

      drawChart(s.dispVals);
      saveLS();
    }

    // --- Events
    $('yearSel').addEventListener('change', render);
    $('displayCurrency').addEventListener('change', render);
    $('eurusd').addEventListener('input', render);
    $('ronusd').addEventListener('input', render);

    $('addAccountBtn').addEventListener('click', () => addAccount());

    $('saveBtn').addEventListener('click', () => { saveLS(); alert('Salvat √Æn browser ‚úÖ'); });
    $('resetBtn').addEventListener('click', () => {
      if (!confirm('Sigur vrei sƒÉ resetezi toate datele?')) return;
      localStorage.removeItem('invTrackerV2');
      state.accounts = {};
      render();
    });

    function loadSample() {
      const y = +yearSel.value;
      ensureYear(y);
      state.accounts[y] = [];
      // Sample account 1 (EUR)
      addAccount({
        name: 'Broker EUR',
        currency: 'EUR',
        values: [8000, 8100, 8250, 8180, 8300, 8450, 8400, 8500, 8600, 8550, 8700, 8850]
      });
      // Sample account 2 (USD)
      addAccount({
        name: 'Crypto USD',
        currency: 'USD',
        values: [2000, 2100, 2150, 2050, 2200, 2400, 2350, 2450, 2600, 2550, 2700, 2900]
      });
      // Sample account 3 (RON)
      addAccount({
        name: 'Fond RON',
        currency: 'RON',
        values: [5000, 5050, 5200, 5300, 5400, 5500, 5600, 5650, 5700, 5750, 5900, 6000]
      });
      render();
    }
    $('sampleBtn').addEventListener('click', loadSample);

    // Bootstrap
    (function init(){
      // populate year options done above
      loadLS();
      render();
    })();
  </script>
</body>
</html>
